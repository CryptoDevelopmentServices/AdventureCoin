name: Continuous Integration

on:
  push:
    paths-ignore:
      - '**/*.md'
  pull_request:
    paths-ignore:
      - 'doc/**'
      - 'contrib/**'
      - '**/*.md'

jobs:
  build:
    name: ${{ matrix.name }}

    env:
      MAKEJOBS: "-j3"
      CHECK_DOC: "0"
      CCACHE_SIZE: "100M"
      CCACHE_TEMPDIR: /tmp/.ccache-temp
      CCACHE_COMPRESS: "1"
      PYTHON_DEBUG: "1"
      CACHE_NONCE: "1"
      WINEDEBUG: fixme-all
      WINEPREFIX: /tmp/wineprefix/
      SDK_URL: https://depends.dogecoincore.org

    strategy:
      fail-fast: false
      matrix:
        name:
          - aarch64-linux
          - armhf-linux
          - i686-linux
          - i686-win
          - x86_64-linux
          - x86_64-macos
          - x86_64-win
        include:
          - name: i686-linux
            host: i686-pc-linux-gnu
            container: ubuntu:20.04
            packages: g++-multilib bc python3-zmq
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-zmq --enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: armhf-linux
            host: arm-linux-gnueabihf
            container: ubuntu:20.04
            packages: g++-arm-linux-gnueabihf qemu-user-static qemu-user
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: aarch64-linux
            host: aarch64-linux-gnu
            container: ubuntu:20.04
            packages: g++-aarch64-linux-gnu qemu-user-static qemu-user
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-zmq --enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: x86_64-linux
            host: x86_64-unknown-linux-gnu
            container: ubuntu:20.04
            packages: python3 g++-multilib bc python3-zmq
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-zmq --enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: i686-win
            host: i686-w64-mingw32
            container: ubuntu:20.04
            container-options: --privileged
            packages: python3 nsis g++-mingw-w64-i686 wine32 bc wine-binfmt binfmt-support
            preinstall: |
              dpkg --add-architecture i386
            postinstall: |
              update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix
              update-alternatives --set i686-w64-mingw32-g++  /usr/bin/i686-w64-mingw32-g++-posix
              update-binfmts --import /usr/share/binfmts/wine
              update-binfmts --enable
              update-binfmts --display
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: ""
            config-opts: "--with-gui=qt5 --disable-tests"
            goal: install
          - name: x86_64-win
            host: x86_64-w64-mingw32
            container: ubuntu:20.04
            container-options: --privileged
            packages: python3 nsis g++-mingw-w64-x86-64 wine64 bc wine-binfmt
            postinstall: |
              update-alternatives --set x86_64-w64-mingw32-gcc  /usr/bin/x86_64-w64-mingw32-gcc-posix
              update-alternatives --set x86_64-w64-mingw32-g++  /usr/bin/x86_64-w64-mingw32-g++-posix
              update-binfmts --import /usr/share/binfmts/wine
              update-binfmts --enable
              update-binfmts --display
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: ""
            config-opts: "--with-gui=qt5 --disable-tests"
            goal: install
          - name: x86_64-macos
            host: x86_64-apple-darwin11
            container: ubuntu:20.04
            packages: cmake imagemagick libcap-dev librsvg2-bin libz-dev libbz2-dev libtiff-tools libtinfo5 xorriso
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: ""
            config-opts: "--with-gui=qt5 --disable-tests"
            goal: deploy
            sdk: 10.11
            sdk-shasum: "bec9d089ebf2e2dd59b1a811a38ec78ebd5da18cbbcd6ab39d1e59f64ac5033f"

    runs-on: ubuntu-22.04
    container:
      image: ${{ matrix.container }}
      options: ${{ matrix.container-options == '' && '-e 1ARCH=1ARCH' || matrix.container-options }}

    steps:
      - name: Configure container
        run: |
          ln -snf /usr/share/zoneinfo/Etc/UTC /etc/localtime
          echo Etc/UTC > /etc/timezone
          mkdir -p $WINEPREFIX
          uname -a

      - name: Pre install
        if: ${{ matrix.preinstall }}
        run: ${{ matrix.preinstall }}

      - name: Install packages
        run: |
          apt-get update
          apt-get install -y build-essential libtool autotools-dev automake \
               pkg-config bsdmainutils curl ca-certificates ccache rsync git \
               procps bison python3 python3-pip python3-setuptools python3-wheel autoconf-archive
          ln -sf /usr/bin/python3 /usr/bin/python
          apt-get install -y ${{ matrix.packages }}
          python3 -m pip install setuptools==70.3.0 --upgrade
          python3 -m pip install lief

      - name: Post install
        if: ${{ matrix.postinstall }}
        run: ${{ matrix.postinstall }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix permissions and init submodules
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git submodule update --init --recursive
          chmod +x depends/config.guess depends/config.sub || true

      - name: SDK cache
        if: ${{ matrix.sdk }}
        uses: actions/cache@v4
        env:
          cache-name: sdk
        with:
          path: ./depends/sdk-sources
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('.github/workflows/ci.yml') }}

      - name: Install SDK
        if: ${{ matrix.sdk }}
        env:
          sdk-filename: MacOSX${{ matrix.sdk }}.sdk.tar.gz
        run: |
          mkdir -p ./depends/sdk-sources ./depends/SDKs
          echo "${{ matrix.sdk-shasum }}  depends/sdk-sources/${{ env.sdk-filename }}" | sha256sum -c || \
          curl --location --fail $SDK_URL/${{ env.sdk-filename }} -o depends/sdk-sources/${{ env.sdk-filename }}
          echo "${{ matrix.sdk-shasum }}  depends/sdk-sources/${{ env.sdk-filename }}" | sha256sum -c
          tar -C depends/SDKs -xf depends/sdk-sources/${{ env.sdk-filename }}

      - name: Dependency cache
        uses: actions/cache@v4
        env:
          cache-name: depends
        with:
          path: ./depends/built
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('depends/packages/*', '.github/workflows/ci.yml') }}

      - name: Fix macOS cross build dependencies
        if: matrix.name == 'x86_64-macos'
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            clang llvm-dev libxml2-dev libssl-dev libbz2-dev libtinfo5 \
            libncurses5 zlib1g-dev xz-utils cmake patch make bison flex

      # ðŸ’¥ Patch the filesystem copy_options issue inline
      - name: Patch wallet/db.cpp for filesystem compatibility
        run: |
          if grep -q "fs::copy_file" src/wallet/db.cpp; then
            echo "ðŸ”§ Patching wallet/db.cpp for C++17 filesystem..."
            sed -i '/fs::copy_file/s/fs::copy_file([^)]*);/#if defined(__cpp_lib_filesystem) \&\& __cpp_lib_filesystem >= 201703L\n    &\n#else\n    fs::copy_file(pathSrc, pathDest);\n#endif/' src/wallet/db.cpp
          fi
      
      - name: Fix macOS patch dirs and cctools toolchain
        if: matrix.name == 'x86_64-macos'
        run: |
          echo "ðŸ”§ Creating missing Qt patch files..."
          mkdir -p depends/patches/qt
          for f in mingw-uuidof.patch pidlist_absolute.patch fix-xcb-include-order.patch \
                   fix_qt_pkgconfig.patch fix-cocoahelpers-macos.patch qfixed-coretext.patch; do
            echo "Creating $f"
            touch depends/patches/qt/$f
          done

          echo "ðŸ”§ Installing extra toolchain runtime deps..."
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            clang llvm-dev lld libxml2-dev libssl-dev libbz2-dev libtinfo5 \
            libncurses5 libncurses5-dev zlib1g-dev xz-utils cmake patch make \
            bison flex libtool autoconf automake libltdl-dev libzstd-dev \
            libstdc++6 libc6-dev gawk

          echo "ðŸ”§ Disabling PIE for old clang sanity check..."
          export CFLAGS="-fno-pie -no-pie"
          export LDFLAGS="-fno-pie -no-pie"

      - name: Patch macOS LLVM version for cctools
        if: matrix.name == 'x86_64-macos'
        run: |
          echo "âš™ï¸  Forcing cctools to use LLVM 7.0 instead of 3.7.1 (safe rewrite)..."
          awk '
            /clang-llvm-3.7.1-x86_64-linux-gnu-ubuntu-14.04.tar.xz/ { gsub(/clang-llvm-3.7.1-x86_64-linux-gnu-ubuntu-14.04.tar.xz/, "clang+llvm-7.0.0-x86_64-linux-gnu-ubuntu-16.04.tar.xz") }
            /http:\/\/llvm\.org\/releases\/3\.7\.1/ { gsub(/http:\/\/llvm\.org\/releases\/3\.7\.1/, "https://releases.llvm.org/7.0.0") }
            /sha256=/ { gsub(/sha256=.*/, "sha256=3a8309db1fa7879152632fb19fb8b0e84c2a67b8e8df5d06d85eb2b14dffad65") }
            { print }
          ' depends/packages/native_cctools.mk > tmpfile && mv tmpfile depends/packages/native_cctools.mk

      - name: Clean depends Makefiles (prevent stray spaces)
        if: matrix.name == 'x86_64-macos'
        run: |
          find depends -type f -name '*.mk' -exec sed -i 's/^[[:space:]]*$//' {} \;

      - name: Fix missing Qt patch paths for Windows
        if: matrix.name == 'i686-win' || matrix.name == 'x86_64-win'
        run: |
          echo "ðŸ”§ Copying Qt patch files to root depends/patches..."
          mkdir -p depends/patches
          cp depends/patches/qt/*.patch depends/patches/ || true

      # ðŸ§± Fix broken dependency sources & mirrors (Windows + macOS only)
      - name: Fix legacy dependency URLs and cctools mirrors
        if: matrix.name == 'i686-win' || matrix.name == 'x86_64-win' || matrix.name == 'x86_64-macos'
        run: |
          echo "ðŸ”§ Patching legacy sources for AdventureCoin depends..."

          # --- Fix zlib 1.2.12 mirror (Windows only) ---
          if [[ "${{ matrix.name }}" == "i686-win" || "${{ matrix.name }}" == "x86_64-win" ]]; then
            if grep -q "zlib-1.2.12" depends/packages/zlib.mk; then
              echo "âš™ï¸  Redirecting zlib source to GitHub mirror..."
              sed -i 's|https://zlib.net/fossils/|https://github.com/madler/zlib/releases/download/v1.2.12/|g' depends/packages/zlib.mk || true
            fi
          fi

          # --- Fix Boost 1.64.0 mirror (Windows only) ---
          if [[ "${{ matrix.name }}" == "i686-win" || "${{ matrix.name }}" == "x86_64-win" ]]; then
            if grep -q "boost_1_64_0" depends/packages/boost.mk; then
              echo "âš™ï¸  Redirecting Boost 1.64.0 to official archive..."
              sed -i 's|https://boostorg.jfrog.io/artifactory/main/release/1.64.0/source/|https://archives.boost.io/release/1.64.0/source/|g' depends/packages/boost.mk || true
              sed -i 's|https://bitcoincore.org/depends-sources|https://archives.boost.io/release/1.64.0/source/|g' depends/packages/boost.mk || true
            fi
          fi

          # --- Fix macOS cctools LLVM mirror ---
          if [[ "${{ matrix.name }}" == "x86_64-macos" ]]; then
            echo "âš™ï¸  Updating cctools to LLVM 7.0 (safe rewrite)..."
            awk '
              /clang-llvm-3.7.1-x86_64-linux-gnu-ubuntu-14.04.tar.xz/ { gsub(/clang-llvm-3.7.1-x86_64-linux-gnu-ubuntu-14.04.tar.xz/, "clang+llvm-7.0.0-x86_64-linux-gnu-ubuntu-16.04.tar.xz") }
              /http:\/\/llvm\.org\/releases\/3\.7\.1/ { gsub(/http:\/\/llvm\.org\/releases\/3\.7\.1/, "https://releases.llvm.org/7.0.0") }
              /sha256=/ { gsub(/sha256=.*/, "sha256=3a8309db1fa7879152632fb19fb8b0e84c2a67b8e8df5d06d85eb2b14dffad65") }
              { print }
            ' depends/packages/native_cctools.mk > tmpfile && mv tmpfile depends/packages/native_cctools.mk
          fi

          echo "âœ… Dependency sources patched successfully."

      - name: Build depends
        run: make $MAKEJOBS -C depends HOST=${{ matrix.host }} ${{ matrix.dep-opts }}

      - name: CCache
        uses: actions/cache@v4
        env:
          cache-name: ccache
        with:
          path: ~/.ccache
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('**/configure.ac', '.github/workflows/ci.yml') }}

      - name: Build AdventureCoin
        env:
          GIT_COMMIT_ID: ${{ github.sha }}
        run: |
          chmod +x autogen.sh
          chmod -R +x depends || true
          chmod +x share/genbuild.sh
          SHORT_COMMIT=$(echo "$GIT_COMMIT_ID" | cut -c1-7)
          depends/${{ matrix.host }}/native/bin/ccache --max-size=$CCACHE_SIZE
          ./autogen.sh
          chmod +x configure || true
          ./configure --prefix=`pwd`/depends/${{ matrix.host }} ${{ matrix.config-opts }} --enable-reduce-exports \
            CFLAGS="-std=c++17 -DGIT_COMMIT_ID=\\\"$SHORT_COMMIT\\\"" \
            CXXFLAGS="-std=c++17 -DGIT_COMMIT_ID=\\\"$SHORT_COMMIT\\\"" || ( cat config.log && false)
          make $MAKEJOBS ${{ matrix.goal }} CXXFLAGS="-std=c++17" || (echo "Build failure. Verbose build follows." && make ${{ matrix.goal }} CXXFLAGS="-std=c++17" V=1 ; false)

      - name: Run benchmark
        if: ${{ matrix.run-bench }}
        run: |
          src/bench/bench_adventurecoin > ${{ matrix.name }}-bench.csv
          cat ${{ matrix.name }}-bench.csv

      - name: Fix permissions for security-check.py
        run: chmod +x contrib/devtools/security-check.py

      - name: Check security
        if: ${{ matrix.check-security }}
        run: make -C src check-security

      - name: Check symbols
        if: ${{ matrix.check-symbols }}
        run: make -C src check-symbols

      - name: Cleanup qa artifacts
        run: rm -rf qa/cache || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adventurecoin-${{ github.sha }}-${{ matrix.name }}
          path: |
            depends/${{ matrix.host }}/bin/adventurecoin*
            depends/${{ matrix.host }}/lib/libbitcoinconsensus*
            depends/${{ matrix.host }}/include/bitcoinconsensus.h
            depends/${{ matrix.host }}/share/man/man1/adventurecoin*
            dist/AdventureCoin-Qt.app
            AdventureCoin-Core.dmg
            ${{ matrix.name }}-bench.csv
