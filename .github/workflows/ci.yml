name: Continuous Integration

on:
  push:
    paths-ignore:
      - '**/*.md'
  pull_request:
    paths-ignore:
      - 'doc/**'
      - 'contrib/**'
      - '**/*.md'

jobs:
  build:
    name: ${{ matrix.name }}

    env:
      MAKEJOBS: "-j3"
      CHECK_DOC: "0"
      CCACHE_SIZE: "100M"
      CCACHE_TEMPDIR: /tmp/.ccache-temp
      CCACHE_COMPRESS: "1"
      PYTHON_DEBUG: "1"
      CACHE_NONCE: "1"
      WINEDEBUG: fixme-all
      WINEPREFIX: /tmp/wineprefix/
      SDK_URL: https://depends.dogecoincore.org

    strategy:
      fail-fast: false
      matrix:
        name:
          - aarch64-linux
          - armhf-linux
          - i686-linux
          - i686-win
          - x86_64-linux
          - x86_64-macos
          - x86_64-win
        include:
          - name: i686-linux
            host: i686-pc-linux-gnu
            container: ubuntu:20.04
            packages: g++-multilib bc python3-zmq
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-zmq --enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: armhf-linux
            host: arm-linux-gnueabihf
            container: ubuntu:20.04
            packages: g++-arm-linux-gnueabihf qemu-user-static qemu-user
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: aarch64-linux
            host: aarch64-linux-gnu
            container: ubuntu:20.04
            packages: g++-aarch64-linux-gnu qemu-user-static qemu-user
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-zmq --enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: x86_64-linux
            host: x86_64-unknown-linux-gnu
            container: ubuntu:20.04
            packages: python3 g++-multilib bc python3-zmq
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: "NO_QT=1"
            config-opts: "--enable-zmq --enable-glibc-back-compat LDFLAGS=-static-libstdc++ --disable-tests"
            goal: install
          - name: i686-win
            host: i686-w64-mingw32
            container: ubuntu:20.04
            container-options: --privileged
            packages: python3 nsis g++-mingw-w64-i686 wine32 bc wine-binfmt binfmt-support
            preinstall: |
              dpkg --add-architecture i386
            postinstall: |
              update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix
              update-alternatives --set i686-w64-mingw32-g++  /usr/bin/i686-w64-mingw32-g++-posix
              update-binfmts --import /usr/share/binfmts/wine
              update-binfmts --enable
              update-binfmts --display
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: ""
            config-opts: "--with-gui=qt5 --disable-tests"
            goal: install
          - name: x86_64-win
            host: x86_64-w64-mingw32
            container: ubuntu:20.04
            container-options: --privileged
            packages: python3 nsis g++-mingw-w64-x86-64 wine64 bc wine-binfmt
            postinstall: |
              update-alternatives --set x86_64-w64-mingw32-gcc  /usr/bin/x86_64-w64-mingw32-gcc-posix
              update-alternatives --set x86_64-w64-mingw32-g++  /usr/bin/x86_64-w64-mingw32-g++-posix
              update-binfmts --import /usr/share/binfmts/wine
              update-binfmts --enable
              update-binfmts --display
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: ""
            config-opts: "--with-gui=qt5 --disable-tests"
            goal: install
          - name: x86_64-macos
            host: x86_64-apple-darwin11
            container: ubuntu:20.04
            packages: cmake imagemagick libcap-dev librsvg2-bin libz-dev libbz2-dev libtiff-tools libtinfo5 xorriso
            run-bench: false
            check-security: true
            check-symbols: false
            dep-opts: ""
            config-opts: "--with-gui=qt5 --disable-tests"
            goal: deploy
            sdk: 10.11
            sdk-shasum: "bec9d089ebf2e2dd59b1a811a38ec78ebd5da18cbbcd6ab39d1e59f64ac5033f"

    runs-on: ubuntu-22.04
    container:
      image: ${{ matrix.container }}
      options: ${{ matrix.container-options == '' && '-e 1ARCH=1ARCH' || matrix.container-options }}

    steps:
      - name: Configure container
        run: |
          ln -snf /usr/share/zoneinfo/Etc/UTC /etc/localtime
          echo Etc/UTC > /etc/timezone
          mkdir -p $WINEPREFIX
          uname -a

      - name: Pre install
        if: ${{ matrix.preinstall }}
        run: ${{ matrix.preinstall }}

      - name: Install packages
        run: |
          apt-get update
          apt-get install -y build-essential libtool autotools-dev automake \
               pkg-config bsdmainutils curl ca-certificates ccache rsync git \
               procps bison python3 python3-pip python3-setuptools python3-wheel autoconf-archive
          ln -sf /usr/bin/python3 /usr/bin/python
          apt-get install -y ${{ matrix.packages }}
          python3 -m pip install setuptools==70.3.0 --upgrade
          python3 -m pip install lief

      - name: Post install
        if: ${{ matrix.postinstall }}
        run: ${{ matrix.postinstall }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix permissions and init submodules
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git submodule update --init --recursive
          chmod +x depends/config.guess depends/config.sub || true

      - name: SDK cache
        if: ${{ matrix.sdk }}
        uses: actions/cache@v4
        env:
          cache-name: sdk
        with:
          path: ./depends/sdk-sources
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('.github/workflows/ci.yml') }}

      - name: Install SDK
        if: ${{ matrix.sdk }}
        env:
          SDK_URL: https://bitcoincore.org/depends-sources/sdks
          sdk-filename: MacOSX${{ matrix.sdk }}.sdk.tar.gz
        run: |
          mkdir -p ./depends/sdk-sources ./depends/SDKs

          # Try primary (Bitcoin Core mirror)
          echo "${{ matrix.sdk-shasum }}  depends/sdk-sources/${{ env.sdk-filename }}" | sha256sum -c || \
          curl --location --fail "$SDK_URL/${{ env.sdk-filename }}" \
            -o "depends/sdk-sources/${{ env.sdk-filename }}" || \
          curl --location --fail "https://raw.githubusercontent.com/theuni/osxcross/master/tarballs/${{ env.sdk-filename }}" \
            -o "depends/sdk-sources/${{ env.sdk-filename }}"

          # Verify checksum again
          echo "${{ matrix.sdk-shasum }}  depends/sdk-sources/${{ env.sdk-filename }}" | sha256sum -c

          # Extract SDK
          tar -C depends/SDKs -xf depends/sdk-sources/${{ env.sdk-filename }}

      - name: Dependency cache
        uses: actions/cache@v4
        env:
          cache-name: depends
        with:
          path: ./depends/built
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('depends/packages/*', '.github/workflows/ci.yml') }}

      # ðŸ§© Fix macOS LLVM 10.0.0 mirror (Ubuntu 18.04 build from GitHub)
      - name: Patch native_cctools.mk to LLVM 10.0.0 (GitHub, Ubuntu 18.04)
        if: matrix.name == 'x86_64-macos'
        shell: bash
        run: |
          set -euo pipefail
          CCTOOLS="depends/packages/native_cctools.mk"

          # âœ… LLVM 10.0.0 toolchain info
          LLVM_VER="10.0.0"
          LLVM_FILE="clang+llvm-${LLVM_VER}-x86_64-linux-gnu-ubuntu-18.04.tar.xz"
          LLVM_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VER}"
          LLVM_SHA="b25f592a0c00686f03e3b7db68ca6dc87418f681f4ead4df4745a01d9be63843"

          # âœ… Corrected cctools-port source (GitHub changed archive path!)
          CCTOOLS_VER="master"
          CCTOOLS_URL="https://github.com/tpoechtrager/cctools-port/archive/refs/heads"
          CCTOOLS_FILE="${CCTOOLS_VER}.tar.gz"
          CCTOOLS_SHA="579c46ce16a269f202de4f4118db00bfdef95e3aa251cc79d4726faef9f4dab2"

          echo "ðŸ§¹ Cleaning old LLVM/cctools artifacts..."
          rm -rf depends/work/download/native_cctools* depends/sources/clang*llvm-* || true

          echo "âš™ï¸ Patching native_cctools.mk..."
          # --- cctools source ---
          sed -i "s|^\$(package)_version=.*|\$(package)_version=${CCTOOLS_VER}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_download_path=.*|\$(package)_download_path=${CCTOOLS_URL}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_file_name=.*|\$(package)_file_name=${CCTOOLS_FILE}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_sha256_hash=.*|\$(package)_sha256_hash=${CCTOOLS_SHA}|" "${CCTOOLS}"

          # --- LLVM toolchain (hard-coded URL + filename to avoid 404) ---
          sed -i "s|^\$(package)_clang_version=.*|\$(package)_clang_version=${LLVM_VER}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_clang_download_path=.*|\$(package)_clang_download_path=${LLVM_URL}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_clang_download_file=.*|\$(package)_clang_download_file=${LLVM_FILE}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_clang_file_name=.*|\$(package)_clang_file_name=${LLVM_FILE}|" "${CCTOOLS}"
          sed -i "s|^\$(package)_clang_sha256_hash=.*|\$(package)_clang_sha256_hash=${LLVM_SHA}|" "${CCTOOLS}"

          echo "ðŸ” Confirming patched fields..."
          grep -E '^\$\(package\)_(version|download_path|file_name|sha256_hash|clang_download_path|clang_file_name|clang_sha256_hash)=' "${CCTOOLS}" || true

          echo "ðŸ“¦ Installing LLVM ${LLVM_VER} toolchain..."
          apt-get update -y
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            clang-10 llvm-10-dev libxml2-dev libedit-dev libncurses5 libtinfo5 \
            libbz2-dev zlib1g-dev lld make patch autoconf automake libtool cmake gawk

          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-10 100
          update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-10 100

          echo "âœ… native_cctools.mk patched with correct GitHub refs/heads/master URL and verified LLVM 10.0.0."

      - name: Patch dsymutil missing issue
        if: matrix.name == 'x86_64-macos'
        shell: bash
        run: |
          set -euo pipefail
          CCTOOLS_DIR="depends/packages/native_cctools.mk"

          echo "âš™ï¸ Disabling dsymutil check (not included in LLVM 10.0.0 Linux build)..."
          sed -i '/llvm-dsymutil/d' "$CCTOOLS_DIR"

          # Patch staging rule to tolerate missing dsymutil
          find depends/work/build/x86_64-apple-darwin11/ -type f -name "Makefile" -print0 | \
            xargs -0 sed -i '/llvm-dsymutil/d' || true

          echo "âœ… dsymutil references removed â€” build will continue without it."

      - name: Fix macOS cross build dependencies
        if: matrix.name == 'x86_64-macos'
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            clang llvm-dev libxml2-dev libssl-dev libbz2-dev libtinfo5 \
            libncurses5 zlib1g-dev xz-utils cmake patch make bison flex

      # ðŸ§© Patch zlib 1.2.12 to use stable KDE mirror (Windows builds)
      - name: Force zlib 1.2.12 from KDE mirror (fix checksum)
        if: matrix.name == 'i686-win' || matrix.name == 'x86_64-win'
        shell: bash
        run: |
          set -euo pipefail
          ZVER="1.2.12"
          ZURL="https://mirrors.ukfast.co.uk/sites/kde.org/files/krita/build/dependencies/zlib-${ZVER}.tar.gz"
          ZSHA="91844808532e5ce316b3c010929493c0244f3d37593afd6de04f71821d5136d9"

          echo "ðŸ“¦ Downloading zlib ${ZVER} from KDE mirror..."
          mkdir -p depends/sources
          curl -L --retry 3 --connect-timeout 15 -o "depends/sources/zlib-${ZVER}.tar.gz" "${ZURL}"

          echo "ðŸ“ Updating depends/packages/zlib.mk..."
          sed -i "s|https://zlib.net/fossils|${ZURL%/zlib-${ZVER}.tar.gz}|g" depends/packages/zlib.mk
          sed -i "s|https://bitcoincore.org/depends-sources|${ZURL%/zlib-${ZVER}.tar.gz}|g" depends/packages/zlib.mk
          sed -i "s/sha256=.*/sha256=${ZSHA}/" depends/packages/zlib.mk

          echo "${ZSHA}  depends/sources/zlib-${ZVER}.tar.gz" > depends/work/download/zlib-zlib-${ZVER}/zlib-${ZVER}.tar.gz.hash || true
          echo "âœ… zlib ${ZVER} patched to KDE mirror with correct checksum."

      # - name: Patch Boost toolset to prevent version clashes
      #   if: matrix.name == 'x86_64-macos'
      #   shell: bash
      #   run: |
      #     BOOST_MK="depends/packages/boost.mk"
      #     USERCFG="depends/sources/boost_1_64_0/tools/build/src/user-config.jam"
      #     mkdir -p "$(dirname $USERCFG)"

      #     echo "ðŸ›  Removing auto-detected darwin toolsets..."
      #     sed -i 's/toolset=darwin//g' "$BOOST_MK" || true

      #     echo "ðŸ›  Forcing Boost to use ONLY darwin-10.0.0..."
      #     sed -i 's#./b2 #./b2 toolset=darwin-10.0.0 #g' "$BOOST_MK"

      #     echo "using darwin : 10.0.0 : x86_64-apple-darwin11-clang++ ;" >> "$USERCFG"

      #     echo "ðŸ” Verifying Boost config override:"
      #     grep -n "darwin-10.0.0" "$BOOST_MK" || true
      #     grep -n "darwin" "$USERCFG" || true

      #     echo "âœ… Boost toolset pinned to darwin-10.0.0 (no conflicts)."

      - name: Build depends
        run: make $MAKEJOBS -C depends HOST=${{ matrix.host }} ${{ matrix.dep-opts }}

      - name: CCache
        uses: actions/cache@v4
        env:
          cache-name: ccache
        with:
          path: ~/.ccache
          key: ${{ matrix.name }}-${{ env.cache-name }}-${{ hashFiles('**/configure.ac', '.github/workflows/ci.yml') }}

      - name: Build AdventureCoin
        env:
          GIT_COMMIT_ID: ${{ github.sha }}
        run: |
          chmod +x autogen.sh
          chmod -R +x depends || true
          chmod +x share/genbuild.sh
          SHORT_COMMIT=$(echo "$GIT_COMMIT_ID" | cut -c1-7)
          depends/${{ matrix.host }}/native/bin/ccache --max-size=$CCACHE_SIZE
          ./autogen.sh
          chmod +x configure || true
          ./configure --prefix=`pwd`/depends/${{ matrix.host }} ${{ matrix.config-opts }} --enable-reduce-exports \
            CFLAGS="-std=c++17 -DGIT_COMMIT_ID=\\\"$SHORT_COMMIT\\\"" \
            CXXFLAGS="-std=c++17 -DGIT_COMMIT_ID=\\\"$SHORT_COMMIT\\\"" || ( cat config.log && false)
          make $MAKEJOBS ${{ matrix.goal }} CXXFLAGS="-std=c++17" || (echo "Build failure. Verbose build follows." && make ${{ matrix.goal }} CXXFLAGS="-std=c++17" V=1 ; false)

      - name: Run benchmark
        if: ${{ matrix.run-bench }}
        run: |
          src/bench/bench_adventurecoin > ${{ matrix.name }}-bench.csv
          cat ${{ matrix.name }}-bench.csv

      - name: Fix permissions for security-check.py
        run: chmod +x contrib/devtools/security-check.py

      # # ðŸ§© Fix Python 3 bytes bug in security-check.py for Windows PE builds
      # - name: Patch security-check.py for Python 3
      #   if: matrix.name == 'x86_64-win' || matrix.name == 'i686-win'
      #   shell: bash
      #   run: |
      #     FILE="contrib/devtools/security-check.py"
      #     echo "ðŸ”§ Patching $FILE for Python 3 compatibility..."
      #     sed -i 's/for line in stdout.split(/for line in stdout.decode().split(/' "$FILE"
      #     grep -n "stdout.decode()" "$FILE" || (echo "âš  patch did not apply!" && exit 1)
      #     echo "âœ… security-check.py patched successfully."

      - name: Check security
        if: ${{ matrix.check-security }}
        run: make -C src check-security

      - name: Check symbols
        if: ${{ matrix.check-symbols }}
        run: make -C src check-symbols

      - name: Cleanup qa artifacts
        run: rm -rf qa/cache || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adventurecoin-${{ github.sha }}-${{ matrix.name }}
          path: |
            depends/${{ matrix.host }}/bin/adventurecoin*
            depends/${{ matrix.host }}/lib/libbitcoinconsensus*
            depends/${{ matrix.host }}/include/bitcoinconsensus.h
            depends/${{ matrix.host }}/share/man/man1/adventurecoin*
            dist/AdventureCoin-Qt.app
            AdventureCoin-Core.dmg
            ${{ matrix.name }}-bench.csv
